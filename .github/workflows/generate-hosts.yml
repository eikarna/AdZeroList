name: Generate Compressed Hosts File

on:
  push:
    branches: [ "main" ]
  schedule:
    # Run for every 3 hours
    - cron: "0 */3 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download host sources
        run: |
          echo "INFO: Downloading from active sources in sources.list..."
          # Filter lines starting with '#' or empty lines, then download
          grep -vE '^\s*(#|$)' lists/sources.list | wget -i - -O hosts.raw
          echo "INFO: Download complete."

      - name: Add custom domains
        run: |
          echo "INFO: Adding custom domains from custom.list..."
          if [ -s lists/custom.list ]; then
            # FIX: Ensure there's a newline before adding custom domains
            echo "" >> hosts.raw
            while IFS= read -r domain; do
              # Ensure line is not empty and not a comment
              if [[ -n "$domain" && ! "$domain" =~ ^\s*# ]]; then
                echo "0.0.0.0 $domain" >> hosts.raw
              fi
            done < lists/custom.list
            echo "INFO: Custom domains added."
          else
            echo "INFO: lists/custom.list is empty. Skipping."
          fi

      - name: Make script executable
        run: chmod +x scripts/hostpress.sh

      - name: Apply whitelist to raw hosts
        run: |
          echo "INFO: Applying whitelist from custom-white.list to hosts.raw..."
          if [ -s lists/custom-white.list ]; then
            # Remove lines containing domains from the whitelist
            # -f option reads patterns from a file, -v inverts the match
            grep -v -f lists/custom-white.list hosts.raw > hosts.raw.whitelisted
            mv hosts.raw.whitelisted hosts.raw
            echo "INFO: Whitelist applied to hosts.raw."
          else
            echo "INFO: lists/custom-white.list is empty. Skipping whitelist application."
          fi

      - name: Run hostpress script to process hosts
        run: |
          echo "INFO: Starting host processing with Bash script..."
          ./scripts/hostpress.sh hosts.raw
          echo "INFO: Host processing finished. Generated multiple output files."

      - name: Get previous hosts.txt hash
        id: old_hash
        run: |
          OLD_HASH=$(git show HEAD~1:hosts.txt 2>/dev/null | sha256sum | awk '{print $1}')
          if [ -z "$OLD_HASH" ]; then
            echo "::set-output name=value::N/A (first run or hosts.txt not in previous commit)"
          else
            echo "::set-output name=value::$OLD_HASH"
          fi

      - name: Get new hosts.txt hash
        id: new_hash
        run: |
          NEW_HASH=$(sha256sum hosts.txt | awk '{print $1}')
          echo "::set-output name=value::$NEW_HASH"

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'AZL - %H:%M:%S %Z (%A, %d %b %Y)')"
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            hosts.txt
            hosts-uncompressed.txt
            dnsmasq.conf
            smartdns.conf
          tag_name: latest
          name: ${{ steps.date.outputs.date }}
          body: |
            Automated hosts file build.
            Triggered by: ${{ github.event_name }}
            Commit: `${{ github.sha }}`
            ---
            hosts.txt Hashes:
            Old: ${{ steps.old_hash.outputs.value }}
            New: ${{ steps.new_hash.outputs.value }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
