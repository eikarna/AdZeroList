name: Generate Compressed Hosts File

on:
  push:
    branches: [ "main" ]
  schedule:
    # Run for every 3 hours
    - cron: "0 */3 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download host sources
        run: |
          echo "INFO: Enhanced processing will handle source downloads..."
          # Create empty file for compatibility
          touch hosts.raw

      - name: Add custom domains
        run: |
          echo "INFO: Enhanced script will handle custom domains automatically..."

      - name: Make scripts executable
        run: |
          chmod +x scripts/hostpress.sh
          chmod +x scripts/hostpress-enhanced.sh

      - name: Apply whitelist to raw hosts
        run: |
          echo "INFO: Enhanced script will handle whitelist automatically..."

      - name: Run enhanced hostpress script
        run: |
          echo "INFO: Starting enhanced host processing..."
          ./scripts/hostpress-enhanced.sh
          echo "INFO: Enhanced host processing finished."

      - name: Get previous hosts.txt hash
        id: old_hash
        run: |
          OLD_HASH=$(git show HEAD~1:hosts.txt 2>/dev/null | sha256sum | awk '{print $1}')
          if [ -z "$OLD_HASH" ]; then
            echo "::set-output name=value::N/A (first run or hosts.txt not in previous commit)"
          else
            echo "::set-output name=value::$OLD_HASH"
          fi

      - name: Get new hosts.txt hash
        id: new_hash
        run: |
          NEW_HASH=$(sha256sum hosts.txt | awk '{print $1}')
          echo "::set-output name=value::$NEW_HASH"

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'AZL - %H:%M:%S %Z (%A, %d %b %Y)')"
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            hosts.txt
            hosts-uncompressed.txt
            dnsmasq.conf
            smartdns.conf
            bind-rpz.conf
            blocky.txt
            unbound.conf
            adblock.txt
            ublock.txt
          tag_name: latest
          name: ${{ steps.date.outputs.date }}
          body: |
            Automated hosts file build.
            Triggered by: ${{ github.event_name }}
            Commit: `${{ github.sha }}`
            ---
            hosts.txt Hashes:
            Old: ${{ steps.old_hash.outputs.value }}
            New: ${{ steps.new_hash.outputs.value }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
